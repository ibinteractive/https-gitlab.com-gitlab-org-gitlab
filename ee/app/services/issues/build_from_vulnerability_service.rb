# frozen_string_literal: true

module Issues
  class BuildFromVulnerabilityService < Issues::BaseService
    def execute
      vulnerability = params[:vulnerability]

      issue_params = {
        title: "Investigate vulnerability: #{vulnerability.title}",
        description: render_description(vulnerability),
        confidential: true
      }

      @issue = @notable = ::Issues::BuildService
        .new(@project, current_user, issue_params).execute

      @issue
    end

    private

    def render_description(vulnerability)
      ApplicationController.render(
        template: 'vulnerabilities/issue_description.md.erb',
        locals: { vulnerability: vulnerability.present }
      )
    end
  end
end

Issues::BuildService.prepend_if_ee('EE::Issues::BuildService')
